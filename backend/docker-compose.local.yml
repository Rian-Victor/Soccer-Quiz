version: "3.8"

services:
  # --- BANCO LOCAL ---
  sql-server:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: soccer-quiz-sql-server-local
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Password123!
    ports:
      - "1434:1433" 
    networks:
      - soccer-quiz-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P Password123! -Q 'SELECT 1' -C -N o"]
      interval: 10s
      retries: 5
      start_period: 10s

  # --- SERVICES ---
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: soccer-quiz-user-service-local
    environment:
      PORT: 3000
      DEBUG: "true"
      DATABASE_URL: "mssql+pyodbc://sa:Password123!@sql-server:1433/soccer_quiz_db?driver=ODBC+Driver+18+for+SQL+Server&Encrypt=no&TrustServerCertificate=yes"
    ports:
      - "3001:3000"
    depends_on:
      sql-server:
        condition: service_healthy 
    networks:
      - soccer-quiz-network

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: soccer-quiz-auth-service-local
    environment:
      PORT: 3000
      DEBUG: "true"
      JWT_SECRET: "local-secret"
      JWT_ALGORITHM: HS256
      DATABASE_URL: "mssql+pyodbc://sa:Password123!@sql-server:1433/soccer_quiz_db?driver=ODBC+Driver+18+for+SQL+Server&Encrypt=no&TrustServerCertificate=yes"
      USER_SERVICE_URL: http://user-service:3000
    ports:
      - "3002:3000"
    depends_on:
      user-service:
        condition: service_started
      sql-server:
        condition: service_healthy
    networks:
      - soccer-quiz-network

  # --- OUTROS SERVIÃ‡OS (Mongo e Quiz) ---
  mongodb:
    image: mongo:7
    container_name: soccer-quiz-mongodb-local
    environment:
      MONGO_INITDB_DATABASE: soccer_quiz
    ports:
      - "27017:27017"
    networks:
      - soccer-quiz-network

  quiz-service:
    build:
      context: ./quiz-service
      dockerfile: Dockerfile
    container_name: soccer-quiz-quiz-service-local
    environment:
      PORT: 3000
      DEBUG: "true"
      MONGODB_URL: mongodb://mongodb:27017
      MONGODB_DB: soccer_quiz
    ports:
      - "3003:3000"
    depends_on:
      mongodb:
        condition: service_started
    networks:
      - soccer-quiz-network

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: soccer-quiz-api-gateway-local
    environment:
      PORT: 3000
      DEBUG: "true"
      JWT_SECRET: "local-secret"
      JWT_ALGORITHM: HS256
      AUTH_SERVICE_URL: http://auth-service:3000
      USER_SERVICE_URL: http://user-service:3000
      QUIZ_SERVICE_URL: http://quiz-service:3000
      CASBIN_MODEL_PATH: app/casbin/rbac_model.conf
      CASBIN_POLICY_PATH: app/casbin/policy.csv
    ports:
      - "3000:3000"
    depends_on:
      auth-service:
        condition: service_started
      user-service:
        condition: service_started
      quiz-service:
        condition: service_started
    networks:
      - soccer-quiz-network

networks:
  soccer-quiz-network:
    driver: bridge